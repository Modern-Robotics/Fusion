module.exports=function(){var e=require("directory-tree"),r=require("fs"),s=require("fs-extra"),n=require("rimraf"),a=require("crypto"),t=require("archiver"),i=require("moment"),u=require("path");const l=require("../../utils/logger"),o=require("../../express");function f(e,r){if("directory"==e.type)e.id=a.createHash("md5").update(e.path).digest("hex"),e.text=e.name,e.name==r.user.username&&(e.state={selected:!0,opened:!0}),f(e.children,r);else if(e.constructor===Array)for(var s=0;s<e.length;s++)f(e[s],r);else"file"==e.type&&(e.id=a.createHash("md5").update(e.path).digest("hex"),e.text=e.name,e.icon="jstree-file")}o.route("/api/files",(function(e,r,s){if(e.isAuthenticated())return s();r.status(401).send("User Unauthenticated")})).get((function(r,s){var n=e(r.user.filepath,{});return f(n,r),s.status(200).json([n])})).post((function(t,o){var f=t.body.operation;if("GET"==f){var c=[],d=e(t.user.filepath+(t.body.directory?"/"+t.body.directory.substr(t.user.username.length):""),{});if(d&&"directory"==d.type)for(var p=0;p<d.children.length;p++){d.children[p].children&&d.children[p].children.length>0&&(d.children[p].children=[]),d.children[p].size=d.children[p].size+" kb",d.children[p].id=a.createHash("md5").update(d.children[p].path).digest("hex");var m=d.children[p].path.indexOf(t.user.username);d.children[p].path=d.children[p].path.substring(m),c.push(d.children[p])}if(!(c.length>0))return o.status(200).json(c);for(let e=0,s=Promise.resolve();e<c.length;e++)s=s.then((function(){return new Promise((function(s){r.stat("app/filesystem/"+c[e].path,(function(r,n){if(r?l.error("Error reading "+c[e].name):c[e].date=i(n.mtime).format("MM/DD/YY  h:mm:ss A"),e==c.length-1)return o.status(200).json(c);s()}))}))}))}else if("CREATE_FILE"==f)r.writeFile(t.user.filepath+"/"+t.body.filename.replace(t.user.username,""),"",(function(e){return e?o.status(500).json({serverMessage:e}):o.status(200).json({serverMessage:t.body.filename.replace(/^.*[\\\/]/,"")+" created"})}));else if("CREATE_FOLDER"==f)r.mkdir(t.user.filepath+"/"+t.body.filename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",(function(e){return e?o.status(500).json({serverMessage:e}):o.status(200).json({serverMessage:t.body.filename.replace(/^.*[\\\/]/,"")+" created"})}));else if("DELETE_FILE"==f)r.unlink(t.user.filepath+"/"+t.body.filename.replace(t.user.username+"/","").replace(t.user.username,""),(function(e){return e?o.status(500).json({serverMessage:"Error deleting file"}):o.status(200).json({serverMessage:"File deleted"})}));else if("DELETE_FOLDER"==f)n(t.user.filepath+"/"+t.body.filename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",(function(e){return e?o.status(500).json({serverMessage:"Error deleting folder"}):o.status(200).json({serverMessage:"Folder deleted"})}));else if("DELETE_MULTI"==f){var h=t.body.files;for(let e=0,s=Promise.resolve();e<h.length;e++)s=s.then((function(){return new Promise((function(s){if("file"==h[e].type){var a=t.user.filepath+"/"+h[e].path.replace(t.user.username+"/","").replace(t.user.username,"");r.unlink(a,(function(r){return r?o.status(500).json({serverMessage:"Error deleting file "+h[e].name}):e+1>=h.length?o.status(200).json({serverMessage:"All files deleted"}):void s()}))}else a=t.user.filepath+"/"+h[e].path.replace(t.user.username+"/","").replace(t.user.username,""),n(a+"/",(function(r){return r?o.status(500).json({serverMessage:"Error deleting folder "+h[e].name}):e+1>=h.length?o.status(200).json({serverMessage:"All files deleted"}):void s()}))}))}))}else if("COPY_FILE"==f){var g=t.body.filepath.replace(t.user.username+"/","").replace(t.user.username,""),v=t.user.filepath+"/"+g.substring(0,Math.max(g.lastIndexOf("/"),g.lastIndexOf("\\"))),E=g.replace(/^.*[\\\/]/,""),M="";(function(e,s){return new Promise((function(n,a){r.readdir(s,(function(r,s){if(r)l.error(r),a();else{for(var t=e.split("."),i=t[0],u=1,o=t[1],f=i+u+"."+o;-1!=s.indexOf(f);)f=i+ ++u+"."+o;n(f)}}))}))})(E,v).then((function(e){M=e,s.copy(v+"/"+E,v+"/"+M,(function(e){return e?o.status(500).json({serverMessage:"Error copying file"}):o.status(200).json({serverMessage:"File copied"})}))}),(function(e){return o.status(500).json({serverMessage:"Error generating filename"})}))}else if("COPY_FOLDER"==f)g=t.body.filepath.replace(t.user.username+"/","").replace(t.user.username,""),v=t.user.filepath+"/"+g.substring(0,Math.max(g.lastIndexOf("/"),g.lastIndexOf("\\"))),E=g.replace(/^.*[\\\/]/,""),M="",function(e,s){return new Promise((function(n,a){r.readdir(s,(function(r,s){if(r)l.error(r),a();else{for(var t=e.split(".")[0],i=1,u=t+i;-1!=s.indexOf(u);)u=t+ ++i;n(u)}}))}))}(E,v).then((function(e){M=e,s.copy(v+"/"+E,v+"/"+M,(function(e){return e?o.status(500).json({serverMessage:"Error copying file"}):o.status(200).json({serverMessage:"File copied"})}))}),(function(e){return o.status(500).json({serverMessage:"Error generating filename"})}));else if("MOVE_FILE"==f){var y=t.user.filepath+"/"+t.body.oldFilename.replace(t.user.username+"/","").replace(t.user.username,""),j=t.user.filepath+"/"+t.body.newFilename.replace(t.user.username+"/","").replace(t.user.username,""),F=u.resolve(t.user.filepath);if(y=u.normalize(y),0!=(j=u.resolve(u.normalize(j))).indexOf(F))return o.status(500).json({serverMessage:"Access to location denied"});r.rename(y,j,(function(e){return e?o.status(500).json({serverMessage:"Error moving file"}):o.status(200).json({serverMessage:"File moved"})}))}else if("MOVE_FOLDER"==f){if(y=t.user.filepath+"/"+t.body.oldFilename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",j=t.user.filepath+"/"+t.body.newFilename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",F=u.resolve(t.user.filepath),y=u.normalize(y),0!=(j=u.resolve(u.normalize(j))).indexOf(F))return o.status(500).json({serverMessage:"Access to location denied"});r.rename(y,j,(function(e){return e?o.status(500).json({serverMessage:"Error moving folder"}):o.status(200).json({serverMessage:"Folder moved"})}))}else if("RENAME_FILE"==f){if(y=t.user.filepath+"/"+t.body.oldFilename.replace(t.user.username+"/","").replace(t.user.username,""),j=t.user.filepath+"/"+t.body.newFilename.replace(t.user.username+"/","").replace(t.user.username,""),F=u.resolve(t.user.filepath),y=u.normalize(y),0!=(j=u.resolve(u.normalize(j))).indexOf(F))return o.status(500).json({serverMessage:"Access to location denied"});r.rename(y,j,(function(e){return e?o.status(500).json({serverMessage:"Error renaming file"}):o.status(200).json({serverMessage:"File renamed"})}))}else{if("RENAME_FOLDER"!=f)return o.status(200).json({serverMessage:"in here else..."});if(y=t.user.filepath+"/"+t.body.oldFilename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",j=t.user.filepath+"/"+t.body.newFilename.replace(t.user.username+"/","").replace(t.user.username,"")+"/",F=u.resolve(t.user.filepath),y=u.normalize(y),0!=(j=u.resolve(u.normalize(j))).indexOf(F))return o.status(500).json({serverMessage:"Access to location denied"});r.rename(y,j,(function(e){return e?o.status(500).json({serverMessage:"Error renaming folder"}):o.status(200).json({serverMessage:"Folder renamed"})}))}})),o.route("/api/files/download").get((function(r,s){var n=r.param("d"),a=JSON.parse(Buffer.from(n,"base64").toString("ascii")),i=a.username,u=a.userFilepath,l=a.filepath;if("file"==a.type){var o=u+"/"+l.replace(i+"/","").replace(i,"");s.download(o)}else{var f=u+"/"+l.replace(i+"/","").replace(i,""),c=(e(f,{}),t("zip"));c.on("error",(function(e){s.status(500).send({error:e.message})})),s.attachment(f.replace(/^.*[\\\/]/,"")+".zip"),c.pipe(s),c.directory(f,f.replace(/^.*[\\\/]/,"")),c.finalize()}}))}();