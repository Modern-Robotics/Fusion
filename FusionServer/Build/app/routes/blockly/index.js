!function(){var e=require("directory-tree"),t=require("scp2"),n=require("ssh2").Client;require("path");const a=require("../../classroom/connection"),o=require("../../utils/logger"),i=require("../../express"),l=require("fs"),s=require("mkdirp"),m=require("../../fusionProgram");var r="",u=e("public/app/components/blockly/Examples",{extensions:/\.blk$/});module.exports=(i.get("/api/blockly",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,t){var n=e.user.filepath+"/Blockly";s(n,(function(e){if(e)return t.status(500).send(e);l.readdir(n,(function(e,n){return e?t.status(500).send(e):t.status(200).send(n)}))}))})),i.post("/api/blockly",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,n){l.stat(e.user.filepath+"/Blockly/"+e.body.filename,(function(i,s){return null==i?n.status(500).json({serverMessage:"A file with that name already exists"}):"ENOENT"!=i.code?n.status(500).json({serverMessage:"An error occurred"}):void l.writeFile(e.user.filepath+"/Blockly/"+e.body.filename,e.body.code,(function(i){return i?n.status(500).json({serverMessage:i}):(a.connected&&(l=e.user.filepath+"/Blockly/"+e.body.filename,s=e.user.username+"/Blockly/"+e.body.filename,t.scp(l,"c3:root@172.16.0.1:/home/c3/FusionFilesystem/"+s,(function(e){e?o.error(e):o.debug(`Created: '${s}' in classroom server`)}))),n.status(200).json({serverMessage:"Program Created Successfully"}));var l,s}))}))})),i.get("/api/blockly/:Program_Name",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,t){l.readFile(e.user.filepath+"/Blockly/"+e.params.Program_Name,"utf8",(function(e,n){e&&t.status(500).send(e),t.status(200).send(n)}))})),i.put("/api/blockly/:Program_Name",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,n){l.readFile(e.user.filepath+"/Blockly/"+e.params.Program_Name,"utf8",(function(i,s){if(i)return n.status(500).send(i);l.writeFile(e.user.filepath+"/Blockly/"+e.params.Program_Name,e.body.code,"utf-8",(function(i){return i?n.status(500).send(i):(a.connected&&(l=e.user.filepath+"/Blockly/"+e.params.Program_Name,s=e.user.username+"/Blockly/"+e.params.Program_Name,t.scp(l,"c3:root@172.16.0.1:/home/c3/FusionFilesystem/"+s,(function(e){e?o.error(e):o.debug(`Updated: '${s}' in classroom server`)}))),n.status(200).json({serverMessage:"Program Updated Successfully"}));var l,s}))}))})),i.delete("/api/blockly/:Program_Name",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,t){l.readFile(e.user.filepath+"/Blockly/"+e.params.Program_Name,"utf8",(function(i,s){return i?t.status(500).json({serverMessage:"File Does Not Exist."}):(l.unlinkSync(e.user.filepath+"/Blockly/"+e.params.Program_Name),a.connected&&(m=e.user.username+"/Blockly/"+e.params.Program_Name,(r=new n).on("ready",(function(){r.exec("rm /home/c3/FusionFilesystem/"+m,(function(e,t){if(e)throw e;t.on("close",(function(e,t){o.debug("Stream :: close :: code: "+e+", signal: "+t),r.end()})).on("data",(function(e){o.verbose("STDOUT: "+e)})).stderr.on("data",(function(e){o.error("STDERR: "+e)}))}))})).connect({host:"172.16.0.1",port:22,username:"c3",password:"root"})),t.status(200).json({serverMessage:"Program Deleted Successfully"}));var m,r}))})),i.post("/api/blockly/start",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,t){var n=m.StartBlocklyProgram(e.body.code,e.user.username,e.body.socketId);return t.status(n.status).json({serverMessage:n.message})})),i.post("/api/blockly/stop",(function(e,t,n){return e.isAuthenticated()?n():t.status(401).send("User Unauthenticated")}),(function(e,t){var n=m.StopProgram(e.user.username);return t.status(n.status).json({serverMessage:n.message})})),i.post("/api/blocklySamplePrograms",(function(e,t){l.readFile(e.body.filepath,"utf8",(function(e,n){return e?t.status(500).send("Error loading example"):t.status(200).send(n)}))})),i.get("/api/blocklyToolbar",(function(e,t){var n='<div class="fusion-toolbar-container"><md-toolbar class="md-menu-toolbar" ng-cloak><div layout="row"><div class="fusion-toolbar"><h2 class="md-toolbar-tools" ng-class="isExampleFile(SelectedFile)">{{displaySaveSymbol(SelectedFile.NeedsSaving)}} {{SelectedFile.Name}}</h2><div><md-menu-bar><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="BLOCKLY.MENUBAR_FILE"></button><md-menu-content><md-menu-item><md-button ng-click="NewBlocklyFile()" translate="BLOCKLY.MENUBAR_FILE_NEW" aria-label="New File"></md-button></md-menu-item><md-menu-item><md-button ng-click="OpenFileDialog(ev)" translate="BLOCKLY.MENUBAR_FILE_OPEN" aria-label="Open File"></md-button></md-menu-item><md-menu-item><md-button ng-click="NewBlocklyFile()" translate="BLOCKLY.MENUBAR_FILE_CLOSE" aria-label="Close File"></md-button></md-menu-item><md-menu-divider></md-menu-divider><md-menu-item><md-button ng-click="SaveBlocklyFile()" translate="BLOCKLY.MENUBAR_FILE_SAVE" aria-label="Save File"></md-button> </md-menu-item><md-menu-item><md-button ng-click="SaveAsDialog(ev)" translate="BLOCKLY.MENUBAR_FILE_SAVE_AS" aria-label="Save File As"></md-button></md-menu-item><md-menu-divider></md-menu-divider><md-menu-item><md-button ng-click="DeleteDialog(ev)" translate="BLOCKLY.MENUBAR_FILE_DELETE" aria-label="Delete File"></md-button></md-menu-item></md-menu-content></md-menu><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="BLOCKLY.MENUBAR_VIEW"></button><md-menu-content><md-menu-item class="md-indent"><md-menu><md-button ng-click="$mdMenu.open()" translate="BLOCKLY.MENUBAR_VIEW_MODE" aria-label="Blockly Mode"></md-button><md-menu-content width="3"><md-menu-item type="radio" ng-model="Settings.Mode" value="basic" ng-click="setToolbox()"><div>{{"BLOCKLY.MENUBAR_VIEW_MODE_BASIC" | translate}}</div></md-menu-item><md-menu-item type="radio" ng-model="Settings.Mode" value="intermediate" ng-click="setToolbox()"><div>{{"BLOCKLY.MENUBAR_VIEW_MODE_INTERMEDIATE" | translate}}</div></md-menu-item></md-menu-content></md-menu> </md-menu-item><md-menu-divider></md-menu-divider><md-menu-item type="checkbox" ng-model="Settings.ShowConsole" ng-click="resizeBlockly()"><div>{{"BLOCKLY.MENUBAR_VIEW_PROGRAM_OUTPUT" | translate}}</div></md-menu-item><md-menu-item type="checkbox" ng-model="Settings.ShowCode" ng-click="resizeBlockly()"><div>{{"BLOCKLY.MENUBAR_VIEW_CODE_WINDOW" | translate}}</div><div translate=""></div></md-menu-item></md-menu-content></md-menu><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="BLOCKLY.MENUBAR_MANAGE"></button><md-menu-content><md-menu-item><md-button ng-click="UploadFilesDialog()" translate="BLOCKLY.MENUBAR_MANAGE_IMPORT" aria-label="Upload Files"></md-button></md-menu-item><md-menu-item><md-button ng-click="DownloadFilesDialog()" translate="BLOCKLY.MENUBAR_MANAGE_EXPORT" aria-label="Download Files"></md-button></md-menu-item></md-menu-content></md-menu><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="BLOCKLY.MENUBAR_HELP"></button><md-menu-content>'+r+'<md-menu-item><md-button ng-click="takeToBlocklyDocs()" translate="BLOCKLY.MENUBAR_HELP_DOCUMENTATION" aria-label="Take to Blockly Documentation"></md-button></md-menu-item></md-menu-content></md-menu></md-menu-bar></div></div></div><div class="fusion-ribbon"><md-button class="fusion-ribbon-button tooltip" ng-click="NewBlocklyFile()" aria-label="New File"><md-tooltip><div translate="BLOCKLY.TOOLBAR_NEW_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-file-alt fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="OpenFileDialog(ev)" aria-label="Open File"><md-tooltip><div translate="BLOCKLY.TOOLBAR_OPEN_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-folder-open fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="SaveBlocklyFile()" aria-label="Save File"><md-tooltip><div translate="BLOCKLY.TOOLBAR_SAVE_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-save fa-lg fa-fw"></i></md-button><md-button class="md-primary fusion-ribbon-button" ng-click="runExistingBlocklyProgram()" aria-label="Run Program"><md-tooltip><div translate="BLOCKLY.TOOLBAR_RUN_FILE_TOOLTIP"></div></md-tooltip><i class="fas fa-play fa-lg fa-fw"></i></md-button><md-button class="md-warn fusion-ribbon-button" ng-click="stopRunningBlocklyProgram()" aria-label="Stop Program"><md-tooltip><div translate="BLOCKLY.TOOLBAR_STOP_FILE_TOOLTIP"></div></md-tooltip><i class="fas fa-stop fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="toggleProgramOutput()" aria-label="Toggle Debug Console"><md-tooltip><div translate="BLOCKLY.TOOLBAR_TOGGLE_OUTPUT"></div></md-tooltip><i class="fas fa-terminal fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="toggleCodeWindow()" aria-label="Toggle Code Window"><md-tooltip><div translate="BLOCKLY.TOOLBAR_SHOW_CODE"></div></md-tooltip><i class="fas fa-code fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="OpenVirtualGamepad()" ng-disabled="DisableVirtualGamepad()" aria-label="Open Virtual Gamepad"><md-tooltip><div translate="BLOCKLY.TOOLBAR_GAMEPAD_TOOLTIP"></div></md-tooltip><i class="fas fa-gamepad fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="openInEditor()" aria-label="Open Program In Editor"><md-tooltip><div translate="BLOCKLY.TOOLBAR_OPEN_IN_EDITOR"></div></md-tooltip><i class="fas fa-external-link-square-alt fa-lg fa-fw"></i></md-button></div></md-toolbar></div>';return t.status(200).send(n)})),void function e(t){if("directory"==t.type)"Examples"==t.name?(r+="<md-menu>",r+='<md-button ng-click="$mdMenu.open()" translate="BLOCKLY.MENUBAR_HELP_EXAMPLES" aria-label="Blockly Examples"></md-button>',r+="<md-menu-content>",e(t.children),r+="</md-menu-content>",r+="</md-menu>"):(r+="<md-menu-item>",r+="<md-menu>",r+='<md-button ng-click="$mdMenu.open()">'+t.name+"</md-button>",r+="<md-menu-content>",e(t.children),r+="</md-menu-content>",r+="</md-menu>",r+="</md-menu-item>");else if(t.constructor===Array)for(var n=0;n<t.length;n++)e(t[n]);else"file"==t.type&&(r+="<md-menu-item>",r+="<md-button ng-click=\"openExampleProgram('"+t.name+"','"+t.path.split("\\").join("/")+"')\">"+t.name+"</md-button>",r+="</md-menu-item>")}(u))}();