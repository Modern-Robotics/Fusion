!function(){var e=require("directory-tree"),t=require("os"),a=require("scp2"),n=require("ssh2").Client;require("path");const r=require("../../classroom/connection"),i=require("../../utils/logger"),s=require("../../express"),o=require("fs"),l=require("mkdirp"),m=require("../../global/fusionSettings"),u=require("../../fusionProgram"),d=require("connect-multiparty")(),c=require("../../controllers/FileUploadController");var p="",f=["Fusion","VirtualGamepad","CoreControl"];let b={};"5.15.0-50-generic"==t.release()?b={name:"Examples",children:[]}:("/usr/local/lib/python2.7/dist-packages",b=e("/usr/local/lib/python2.7/dist-packages",{extensions:/\.py$/}),b.name="Examples");for(var g=b.children.length-1;g>=0;g--)if(-1==f.indexOf(b.children[g].name))b.children.splice(g,1);else if(f.indexOf(b.children[g].name)>-1&&"directory"==b.children[g].type)for(var E=0;E<b.children[g].children.length;E++)if("examples"==b.children[g].children[E].name&&"directory"==b.children[g].children[E].type){b.children[g].children[E].name=b.children[g].name,b.children[g]=b.children[g].children[E];break}module.exports=(s.get("/api/programs",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){var a=e.user.filepath+"/Editor";l(a,(function(e){e&&t.status(500).send(e),o.readdir(a,(function(e,a){return e?t.status(500).send(e):t.status(200).send(a)}))}))})),s.post("/api/programs",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){o.stat(e.user.filepath+"/Editor/"+e.body.filename,(function(n,s){return null==n?t.status(500).json({serverMessage:"A file with that name already exists"}):"ENOENT"!=n.code?t.status(500).json({serverMessage:"An error occurred"}):void o.writeFile(e.user.filepath+"/Editor/"+e.body.filename,e.body.code,(function(n){return n?t.status(500).json({serverMessage:n}):(r.connected&&(s=e.user.filepath+"/Editor/"+e.body.filename,o=e.user.username+"/Editor/"+e.body.filename,a.scp(s,"c3:root@172.16.0.1:/home/c3/FusionFilesystem/"+o,(function(e){e?i.error(e):i.debug(`Created: '${o}' in classroom server`)}))),t.status(200).json({serverMessage:"Program Created Successfully"}));var s,o}))}))})),s.get("/api/programs/:Program_Name",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){o.readFile(e.user.filepath+"/Editor/"+e.params.Program_Name,"utf8",(function(a,n){return a?t.status(500).send(a):t.status(200).json({filename:e.params.Program_Name,code:n})}))})),s.put("/api/programs/:Program_Name",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){o.readFile(e.user.filepath+"/Editor/"+e.params.Program_Name,"utf8",(function(n,s){if(n)return t.status(500).send(n);o.writeFile(e.user.filepath+"/Editor/"+e.params.Program_Name,e.body.code,"utf-8",(function(n){return n?t.status(500).send(n):(r.connected&&(s=e.user.filepath+"/Editor/"+e.params.Program_Name,o=e.user.username+"/Editor/"+e.params.Program_Name,a.scp(s,"c3:root@172.16.0.1:/home/c3/FusionFilesystem/"+o,(function(e){e?i.error(e):i.debug(`Updated: '${o}' in classroom server`)}))),t.status(200).json({serverMessage:"Program Updated Successfully"}));var s,o}))}))})),s.delete("/api/programs/:Program_Name",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){o.readFile(e.user.filepath+"/Editor/"+e.params.Program_Name,"utf8",(function(a,s){return a?t.status(500).send("File Does Not Exist."):(o.unlinkSync(e.user.filepath+"/Editor/"+e.params.Program_Name),r.connected&&(l=e.user.username+"/Editor/"+e.params.Program_Name,(m=new n).on("ready",(function(){m.exec("rm /home/c3/FusionFilesystem/"+l,(function(e,t){if(e)throw e;t.on("close",(function(e,t){i.info("Stream :: close :: code: "+e+", signal: "+t),m.end()})).on("data",(function(e){i.info("STDOUT: "+e)})).stderr.on("data",(function(e){i.error("STDERR: "+e)}))}))})).connect({host:"172.16.0.1",port:22,username:"c3",password:"root"})),t.status(200).json({serverMessage:"Program Deleted Successfully"}));var l,m}))})),s.post("/api/programs/start/:Program_Name",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){var a=u.StartProgram(e.user.username,e.user.filepath+"/Editor/"+e.params.Program_Name,e.body.socketId);return t.status(a.status).json({serverMessage:a.message})})),s.post("/api/programs/stop",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){var a=u.StopProgram(e.user.username);return t.status(a.status).json({serverMessage:a.message})})),s.post("/api/programs/sendInput",(function(e,t,a){return e.isAuthenticated()?a():t.status(401).send("User Unauthenticated")}),(function(e,t){return m.SocketVariables.fusion_program_running&&u.sendInput(e.body.input),t.status(200).send()})),s.post("/api/programs/import",d,c.uploadFile,(function(e,t){})),s.get("/api/samplePrograms",(function(a,n){var r;r="5.15.0-50-generic"==t.release()?"C:/Users/Hector/Desktop/examples":"/usr/local/lib/python2.7/dist-packages/Fusion/examples";var i=e(r);return n.status(200).json(i)})),s.post("/api/samplePrograms",(function(e,t){o.readFile(e.body.filepath,"utf8",(function(e,a){return e?t.status(500).send("Error loading example"):t.status(200).json({code:a})}))})),s.post("/api/samplePrograms/run",(function(e,t){var a=u.StartProgram(e.user.username,e.body.filepath,e.body.socketId);return t.status(a.status).json({serverMessage:a.message})})),s.get("/api/editor/toolbar",(function(e,t){var a='<div class="fusion-toolbar-container"><md-toolbar class="md-menu-toolbar"><div layout="row"><div class="fusion-toolbar"><h2 class="md-toolbar-tools" ng-class="isExampleFile(SelectedFile)">{{displaySaveSymbol(SelectedFile.NeedsSaving)}} {{SelectedFile.Name}}</h2><md-menu-bar><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="EDITOR.MENUBAR_FILE"></button><md-menu-content><md-menu-item><md-button ng-click="CreateNewWorkspaceFile()" translate="EDITOR.MENUBAR_FILE_NEW" aria-label="New File"></md-button></md-menu-item><md-menu-item><md-button ng-click="OpenFileDialog(ev)" translate="EDITOR.MENUBAR_FILE_OPEN" aria-label="Open File"></md-button></md-menu-item><md-menu-item><md-button ng-click="CloseFile(SelectedFile)" translate="EDITOR.MENUBAR_FILE_CLOSE" aria-label="Close File"></md-button></md-menu-item><md-menu-divider></md-menu-divider><md-menu-item><md-button ng-click="SaveFileDialog()" translate="EDITOR.MENUBAR_FILE_SAVE" aria-label="Save File"></md-button></md-menu-item><md-menu-item><md-button ng-click="SaveAsDialog(ev)" translate="EDITOR.MENUBAR_FILE_SAVE_AS" aria-label="Save File As"></md-button></md-menu-item><md-menu-item><md-button ng-click="SaveAllDialog()" translate="EDITOR.MENUBAR_FILE_SAVE_ALL" aria-label="Save All Files"></md-button></md-menu-item><md-menu-divider></md-menu-divider><md-menu-item><md-button ng-click="DeleteDialog(ev)" translate="EDITOR.MENUBAR_FILE_DELETE" aria-label="Delete File"></md-button></md-menu-item><md-menu-divider></md-menu-divider><md-menu-item><md-button ng-click="PrintDialog()" translate="EDITOR.MENUBAR_FILE_PRINT" aria-label="Print File"></md-button></md-menu-item></md-menu-content></md-menu><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="EDITOR.MENUBAR_MANAGE">Manage</button><md-menu-content><md-menu-item><md-button ng-click="UploadFilesDialog()" translate="EDITOR.MENUBAR_MANAGE_IMPORT" aria-label="Import Files"></md-button></md-menu-item><md-menu-item><md-button ng-click="DownloadFilesDialog()" translate="EDITOR.MENUBAR_MANAGE_EXPORT" aria-label="Download Files"></md-button></md-menu-item></md-menu-content></md-menu><md-menu><button ng-click="$mdMenu.open()" class="fusion-toolbar-item" translate="EDITOR.MENUBAR_HELP"></button><md-menu-content>'+p+'<md-menu-item><md-button ng-click="takeToEditorDocs()" translate="EDITOR.MENUBAR_HELP_DOCUMENTATION" aria-label="Editor Documentation"></md-button></md-menu-item></md-menu-content></md-menu></md-menu-bar></div></div><div class="fusion-ribbon"><md-button class="fusion-ribbon-button tooltip" ng-click="CreateNewWorkspaceFile()" aria-label="New File"><md-tooltip><div translate="EDITOR.TOOLBAR_NEW_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-file-alt fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="OpenFileDialog(ev)" aria-label="Open File"><md-tooltip><div translate="EDITOR.TOOLBAR_OPEN_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-folder-open fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="SaveFileDialog()" aria-label="Save File As"><md-tooltip><div translate="EDITOR.TOOLBAR_SAVE_FILE_TOOLTIP"></div></md-tooltip><i class="far fa-save fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="SaveAllDialog()" aria-label="Save All Files"><md-tooltip><div translate="EDITOR.TOOLBAR_SAVE_FILES_TOOLTIP"></div></md-tooltip><span class="fa-layers fa-fw  fa-lg fa-fw"><i class="far fa-save" data-fa-transform="shrink-3 down-8 left-4"></i><i class="far fa-save" data-fa-transform="shrink-3 up-2 right-4"></i></span></md-button><md-button class="md-primary fusion-ribbon-button" ng-click="RunExistingEditorFile()" aria-label="Run Program"><md-tooltip><div translate="EDITOR.TOOLBAR_RUN_FILE_TOOLTIP"></div></md-tooltip><i class="fas fa-play fa-lg fa-fw"></i></md-button><md-button class="md-warn fusion-ribbon-button" ng-click="StopRunningEditorFile()" aria-label="Stop Program"><md-tooltip><div translate="EDITOR.TOOLBAR_STOP_FILE_TOOLTIP"></div></md-tooltip><i class="fas fa-stop fa-lg fa-fw"></i></md-button><md-button class="fusion-ribbon-button" ng-click="OpenVirtualGamepad()" ng-disabled="DisableVirtualGamepad()" aria-label="Open Virtual Gamepad"><md-tooltip><div translate="EDITOR.TOOLBAR_GAMEPAD_TOOLTIP"></div></md-tooltip><i class="fas fa-gamepad fa-lg fa-fw"></i></md-button></div></md-toolbar></div>';return t.status(200).send(a)})),void function e(t){if("directory"==t.type)"Examples"==t.name?(p+="<md-menu>",p+='<md-button ng-click="$mdMenu.open()" translate="EDITOR.MENUBAR_HELP_EXAMPLES" aria-label="Editor Examples"></md-button>',p+="<md-menu-content>",e(t.children),p+="</md-menu-content>",p+="</md-menu>"):(p+="<md-menu-item>",p+="<md-menu>",p+='<md-button ng-click="$mdMenu.open()">'+t.name+"</md-button>",p+="<md-menu-content>",e(t.children),p+="</md-menu-content>",p+="</md-menu>",p+="</md-menu-item>");else if(t.constructor===Array)for(var a=0;a<t.length;a++)e(t[a]);else"file"==t.type&&(p+="<md-menu-item>",p+="<md-button ng-click=\"openExampleProgram('"+t.name+"','"+t.path.split("\\").join("/")+"')\">"+t.name+"</md-button>",p+="</md-menu-item>")}(b))}();