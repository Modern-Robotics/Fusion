!function(){var s=require("fs-extra"),e=(require("mkdirp"),require("os")),t=require("path"),n=require("shelljs"),i=require("wireless-tools/wpa_cli"),o=require("wireless-tools/iwlist"),r=(require("wireless-tools/wpa_supplicant"),require("child_process").spawn);const a=require("config"),u=require("../../models/autonomous"),c=require("../../utils/logger"),d=require("./../../utils/wireless");let l=a.get("Wifi_NIC");const p=require("../../express"),f=require("../../models/user"),g=require("../../socket"),w=require("../../global/fusionSettings");module.exports=function(){p.post("/api/admin/users",(function(s,e,t){if(s.isAuthenticated())return t();e.status(401).send("User Unauthenticated")}),(function(s,e){f.findOne({username:s.body.username},(async function(t,n){if(t)return e.status(500).send(t);if(n)return e.status(500).send("Username already taken.");var i=new f(s.body);i.username=s.body.username,i.password=i.generateHash(s.body.password),i.filepath=await i.generateFileSystem(i.username),i.save((function(s){return s?e.status(500).send(s):e.status(200).json({serverMessage:"User created!"})}))}))})),p.get("/api/admin/powerOff",(function(s,e){e.status(200).json({serverMessage:"Shut Down Commencing"});(0,require("child_process").spawn)("sudo",["poweroff"])})),p.get("/api/admin/restart",(function(s,e){e.status(200).send("Restart Commencing");(0,require("child_process").spawn)("sudo",["reboot"])})),p.get("/api/admin/wirelessSettings",(function(t,n){var i,o,r,a=require("os").EOL,u={};"5.15.0-50-generic"==e.release()?(i="../../etc/config-wap/hostapd.conf__npp.sh",s.readFile(i,"utf8",(function(s,e){s&&n.status(500).send("Wifi file not found"),o=e.split("\n");for(var t=0;t<o.length;t++)"ssid"==(r=o[t].split("="))[0]?u.SSID=r[1]:"wpa_passphrase"==r[0]&&(u.Password=r[1]);n.status(200).json({SSID:u.SSID,Password:u.Password})}))):(i="/etc/hostapd/hostapd.conf",s.readFile(i,"utf8",(function(s,e){s&&n.status(500).send("Wifi file not found"),o=e.split(a);for(var t=0;t<o.length;t++)"ssid"==(r=o[t].split("="))[0]?u.SSID=r[1]:"wpa_passphrase"==r[0]&&(u.Password=r[1]);u.SSID||(u.SSID="Not configured..",u.Password=""),n.status(200).json({SSID:u.SSID,Password:u.Password})})))})),p.post("/api/admin/wirelessSettings",(function(s,e){try{var n,i,o=t.join("..","..","etc","ssid_set.py");i=null==s.body.ssid&&null==s.body.password?["python",o,"-d"]:["python",o,"-s",s.body.ssid,"-p",s.body.password];var r=require("child_process").spawn;python_process=r("sudo",i,{stdio:"pipe"}),python_process.stderr.on("data",(function(s){c.info(String(s)),n=String(s)})),python_process.stdout.on("close",(function(s){return n?e.status(500).send(n):e.status(200).json({serverMessage:"Successfully changed wifi settings"})}))}catch(s){return c.info(s),e.status(500).send(s)}})),p.get("/api/admin/wirelessConnections",(function(s,t){if("5.15.0-50-generic"==e.release())return t.status(200).send();o.scan(l,(function(s,e){return s?t.status(500).send("Wireless interface not found"):t.status(200).send({serverMessage:"Retreived wireless connections",data:e})}))})),p.post("/api/admin/wirelessConnections",(async function(s,e){try{c.debug("Connecting to network: "+s.body.ssid);let t={ssid:s.body.ssid,password:s.body.password,hidden:!1};await d.connectToNetwork(t);let n=await d.getNetworkStatus();return g.sockets.emit("wifi-connection",n),e.status(200).json({serverMessage:"Connected to "+s.body.ssid+" successfully"})}catch(t){c.warn("Error connecting to classroom network: "+t);let n=await d.getNetworkStatus();return g.sockets.emit("wifi-connection",n),e.status(500).send("Error connecting to "+s.body.ssid)}})),p.get("/api/admin/wirelessConnections/disconnect",(function(t,o){if("5.15.0-50-generic"==e.release())o.status(500).send("Disconnect not available on Windows");else{s.writeFile("/etc/wpa_supplicant/wpa_supplicant.conf","ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev\nupdate_config=1\ncountry=US\n\n",(function(s){if(s)return o.status(500).send(s);n.exec(`sudo wpa_cli -i ${l} reconfigure`,{silent:!0});var e=setInterval((function(){i.status(l,(function(s,t){return s?o.status(500).send(s):(w.SocketVariables.fusion_wifi_access=t,g.sockets.emit("wifi-connection",t),"DISCONNECTED"==t.wpa_state||"INACTIVE"==t.wpa_state?(clearInterval(e),g.sockets.emit("wifi-connection",t),o.status(200).json({serverMessage:"Disconnected successfully"})):-1==connectingStatuses.indexOf(t.wpa_state)?(clearInterval(e),g.sockets.emit("wifi-connection",t),o.status(500).send("Error disconnecting")):void 0)}))}),300)}))}})),p.get("/api/admin/crashReport",(function(e,t){var n=".crash";s.readdir(n,(function(e,n){return e?t.status(500).send(e):n.length>0?void s.readFile(".crash/"+n[0],"utf8",(function(s,e){return s?status(500).send("Error reading crash file"):(t.setHeader("Content-disposition","attachment; filename="+n[0]),t.status(200).download(".crash/"+n[0]))})):t.status(200).send("No crash files found")}))}));var a=null;p.post("/api/diagnostics/start",(function(s,t){if("5.15.0-50-generic"==e.release())return t.status(200).json({serverMessage:"Diagnostic tool does not run on windows"});(a=r("sudo",["sh","../../diagnostics/runRemi.sh","../../diagnostics/diagnosticGUI.py"])).stdout.on("data",(function(s){c.info(String(s))})),a.stderr.on("data",(function(s){c.info(String(s))}));var i=1,o=setInterval((function(){if(!(i<=3))return clearInterval(o),t.status(500).send("Error starting diagnostic tool");var e=n.exec("ps aux | grep '[s]udo python ../../diagnostics/diagnosticGUI.py' | awk '{print $2}'",{silent:!0}).stdout;if(e)return clearInterval(o),w.SocketVariables.fusion_diagnostics_running={process:e,socket:s.body.socketId},g.sockets.emit("diagnostics_running",w.SocketVariables.fusion_diagnostics_running),t.status(200).json({serverMessage:"Diagnostic tool started successfully"});i++}),300)})),p.get("/api/diagnostics/stop",(function(s,t){if("5.15.0-50-generic"==e.release())return t.status(200).json({serverMessage:"Diagnostic tool does not run on windows"});n.exec("sudo kill $(ps aux | grep '[s]udo python ../../diagnostics/diagnosticGUI.py' | awk '{print $2}')",{silent:!0}),n.exec("ps aux | grep '[s]udo python ../../diagnostics/diagnosticGUI.py' | awk '{print $2}'",{silent:!0},(function(s,e,n){e.trim().trim()?t.status(500).send("Unable to stop diagnostic tool"):(w.SocketVariables.fusion_diagnostics_running=null,g.sockets.emit("diagnostics_running",w.SocketVariables.fusion_diagnostics_running),a=null,t.status(200).json({serverMessage:"Diagnostic tool stopped successfully"}))}))})),p.get("/api/autonomous",(async function(s,e){try{const s=await u.findOne().exec();return e.json(s)}catch(s){return e.status(500).send(error.message)}})),p.post("/api/autonomous",(async function(s,e){try{await u.findOneAndUpdate({},s.body);return e.status(200).json({serverMessage:"Updated successfully"})}catch(s){return e.status(500).send(s.message)}})),p.post("/api/autonomousPrograms",(async function(e,t){try{const n=e.body.username,i=e.body.type,o=await s.readdir(`./app/filesystem/${n}/${i}`);return t.status(200).json({files:o})}catch(s){return t.status(500).send(s.message)}}))}()}();