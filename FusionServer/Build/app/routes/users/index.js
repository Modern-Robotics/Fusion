!function(){require("scp2");var e=require("ssh2").Client,r=require("fs-extra"),t=(require("path"),require("request-promise"));const n=require("../../classroom/connection"),s=require("../../utils/logger"),o=require("../../express"),i=require("../../models/user"),a=require("passport"),u=require("../../global/fusionSettings"),c=require("../../fusionProgram");module.exports=function(){async function d(e,r,t){a.authenticate("local-signup",(async function(o,i,a){if(o)return r.status(500).send(o);if(a&&a.message)return r.status(500).send(e.__(a.message));if(u.MultiUserAccess){if(n.connected)try{await y(i)}catch(e){s.error(e)}e.logIn(i,(function(n){return n?t(n):(f(e.body.socketId,i),r.status(200).json({serverMessage:e.__("REGISTER.CREATED"),user:i}))}))}else{if(0!=m())return r.status(500).send(e.__("REGISTER.CREATED_BUT_MAX_LOGIN_EXCEEDED"));if(n.connected)try{await y(i)}catch(e){s.error(e)}e.logIn(i,(function(n){return n?t(n):(f(e.body.socketId,i),r.status(200).json({serverMessage:e.__("REGISTER.CREATED"),user:i}))}))}}))(e,r,t)}async function l(e,r,t){a.authenticate("local-login",(async function(o,i,a){return o?r.status(500).send(e.__(o.message)):i?void e.logIn(i,(async function(o){if(o)return t(o);f(e.body.socketId,i);try{n.connected&&await y(i)}catch(e){s.error(e)}return r.status(200).json({serverMessage:e.__("LOGIN.SUCCESS"),user:i})})):r.status(401).send(e.__(a.message))}))(e,r,t)}function m(){for(var e=0,r=0;r<u.connectedClients.length;r++)u.connectedClients[r].User&&e++;return e}function f(e,r){for(var t=0;t<u.connectedClients.length;t++)if(u.connectedClients[t].id==e){u.connectedClients[t].User=r;break}}async function y(t){try{await function(t){return new Promise((function(n,o){var i=new e;i.on("ready",(function(){i.sftp((async function(e,a){if(e)return s.error("Error communicating with c3: "+e),i.end(),o(e);try{await function(e){return new Promise((function(r,t){e.readdir("/home/c3/FusionFilesystem/",(function(n){if(!n)return s.verbose("Classroom file system found"),r();e.mkdir("/home/c3/FusionFilesystem/",(function(e){return e?t("Error creating classroom file system: "+e):(s.verbose("Classroom file system created"),r())}))}))}))}(a),await function(e,r){return new Promise((function(t,n){e.readdir("/home/c3/FusionFilesystem/"+r,(function(o){if(!o)return s.verbose("User's classroom file system found"),t();e.mkdir("/home/c3/FusionFilesystem/"+r,(function(e){return e?n("Error creating user's classroom file system: "+e):(s.verbose("User's classroom file system created"),t())}))}))}))}(a,t.username),await function(e,r){return new Promise((function(t,n){e.readdir("/home/c3/FusionFilesystem/"+r+"/Editor/",(function(o){if(!o)return s.verbose("User's editor directory found"),t();e.mkdir("/home/c3/FusionFilesystem/"+r+"/Editor/",(function(e){return e?n("Error creating user's editor directory: "+e):(s.verbose("User's editor directory created"),t())}))}))}))}(a,t.username),await function(e,r){return new Promise((function(t,n){e.readdir("/home/c3/FusionFilesystem/"+r+"/Blockly/",(function(o){if(!o)return s.verbose("User's blockly directory found"),t();e.mkdir("/home/c3/FusionFilesystem/"+r+"/Blockly/",(function(e){return e?n("Error creating user's blockly directory: "+e):(s.verbose("User's blockly directory created"),t())}))}))}))}(a,t.username);let e=await function(e,r){return new Promise((async function(t,n){try{let n={};return n.Editor=await function(e,r){return new Promise((function(t,n){e.readdir("/home/c3/FusionFilesystem/"+r+"/Editor/",(function(e,r){if(e)return n(e);let o=[];for(let e=0;e<r.length;e++)s.debug("Getting data for "+r[e].filename),o.push(r[e]);return t(o)}))}))}(e,r),n.Blockly=await function(e,r){return new Promise((function(t,n){e.readdir("/home/c3/FusionFilesystem/"+r+"/Blockly/",(function(e,r){if(e)return n(e);let o=[];for(let e=0;e<r.length;e++)s.debug("Getting data for "+r[e].filename),o.push(r[e]);return t(o)}))}))}(e,r),t(n)}catch(e){return n(e)}}))}(a,t.username);s.debug(JSON.stringify(e));let o=await(u=t.filepath,new Promise((async function(e,t){try{let t={};return t.Editor=await function(e){return new Promise((async function(t,n){try{let n=[],o=await r.readdir(e+"/Editor");for(let t=0;t<o.length;t++){s.debug("Getting data for "+o[t]);let i=await r.stat(e+"/Editor/"+o[t]);i.name=o[t],n.push(i)}return t(n)}catch(e){return n(e)}}))}(u),t.Blockly=await function(e){return new Promise((async function(t,n){try{let n=[],o=await r.readdir(e+"/Blockly");for(let t=0;t<o.length;t++){s.debug("Getting data for "+o[t]);let i=await r.stat(e+"/Blockly/"+o[t]);i.name=o[t],n.push(i)}return t(n)}catch(e){return n(e)}}))}(u),e(t)}catch(e){return t(e)}})));return s.debug(JSON.stringify(o)),await function(e,r,t,n){return new Promise((async function(o,i){try{for(let o=0;o<t.Editor.length;o++){let a=!1;for(let u=0;u<n.Editor.length;u++)if(n.Editor[u].name==t.Editor[o].filename){if(s.debug(`Local mtime: ${Math.floor(n.Editor[u].mtimeMs/1e3)}`),s.debug(`Remote mtime: ${t.Editor[o].attrs.mtime}`),Math.floor(n.Editor[u].mtimeMs/1e3)>t.Editor[o].attrs.mtime){a=!0,s.debug(`Local "${n.Editor[u].name}" newer, updating classroom version`);try{await g(e,r,t.Editor[o].filename,"Editor")}catch(e){return i(e)}break}a=!0,s.debug(`Remote "${n.Editor[u].name}" newer, updating local version`);try{await h(e,r,t.Editor[o].filename,"Editor")}catch(e){return s.error("Error: "+e),i(e)}break}if(!a){s.debug(`${t.Editor[o].filename} not a common file!`);try{await h(e,r,t.Editor[o].filename,"Editor")}catch(e){return i(e)}}}for(let o=0;o<t.Blockly.length;o++){let a=!1;for(let u=0;u<n.Blockly.length;u++)if(n.Blockly[u].name==t.Blockly[o].filename){if(s.debug(`Local mtime: ${Math.floor(n.Blockly[u].mtimeMs/1e3)}`),s.debug(`Remote mtime: ${t.Blockly[o].attrs.mtime}`),Math.floor(n.Blockly[u].mtimeMs/1e3)>t.Blockly[o].attrs.mtime){a=!0,s.debug(`Local "${n.Blockly[u].name}" newer, updating classroom version`);try{await g(e,r,t.Blockly[o].filename,"Blockly")}catch(e){return i(e)}break}a=!0,s.debug(`Remote "${n.Blockly[u].name}" newer, updating local version`);try{await h(e,r,t.Blockly[o].filename,"Blockly")}catch(e){return s.error("Error: "+e),i(e)}break}if(!a){s.debug(`${t.Blockly[o].filename} not a common file!`);try{await h(e,r,t.Blockly[o].filename,"Blockly")}catch(e){return i(e)}}}return o()}catch(e){return i(e)}}))}(a,t,e,o),i.end(),n()}catch(e){return s.info(e),i.end(),o(e)}var u}))})).connect({host:"172.16.0.1",port:22,username:"c3",password:"root"})}))}(t)}catch(e){s.error("Error downloading classroom files for "+t.username)}}function g(e,r,t,n){return new Promise(((o,i)=>{try{let a=`/home/c3/FusionFilesystem/${r.username}/${n}/${t}`,u=`${r.filepath}/${n}/${t}`;s.debug(`Remote path: ${a}`),s.debug(`Local Path: ${u}`),e.fastPut(u,a,{},(function(e){return e?(s.error("Error uploading file: "+t),i(e)):(s.debug(`Uploaded ${t}`),o())}))}catch(e){return i(e)}}))}function h(e,r,t,n){return new Promise(((o,i)=>{try{let a=`/home/c3/FusionFilesystem/${r.username}/${n}/${t}`,u=`${r.filepath}/${n}/${t}`;s.debug(`Remote path: ${a}`),s.debug(`Local Path: ${u}`),e.fastGet(a,u,{},(function(e){return e?(s.error("Error downloading file: "+t),i(e)):(s.debug(`Retrieved ${t}`),o())}))}catch(e){return i(e)}}))}o.get("/api/users",(function(e,r,t){return e.isAuthenticated()?t():r.status(401).send("User Unauthenticated")}),(function(e,r){i.find({usergroup:{$ne:"Guest"}},(function(e,t){e&&r.send(e),r.json(t)}))})),o.post("/api/users",(async function(e,r,t){await d(e,r,t)})),o.post("/api/users",a.authenticate("local-signup",{session:!0}),(function(e,r){if(e.user.Error)return r.status(500).send(e.user.Error)})),o.get("/api/users/:User_Id",(function(e,r,t){return e.isAuthenticated()?t():r.status(401).send("User Unauthenticated")}),(function(e,r){i.findOne({username:e.params.User_Id.toLowerCase().trim()},(function(e,t){e&&r.send(e),r.json(t)}))})),o.put("/api/users/:User_Id",(function(e,r,t){return e.isAuthenticated()?t():r.status(401).send("User Unauthenticated")}),(function(e,r){i.findOne({username:e.params.User_Id.toLowerCase().trim()},(function(t,n){t&&r.send(t),e.body.password&&(n.password=n.generateHash(e.body.password)),e.body.firstname&&(n.firstname=e.body.firstname),e.body.lastname&&(n.lastname=e.body.lastname),e.body.language&&(n.language=e.body.language),e.body.email&&(n.email=e.body.email),e.body.defaultprogramminglanguage&&(n.defaultprogramminglanguage=e.body.defaultprogramminglanguage),e.body.securityquestion&&(n.securityquestion=e.body.securityquestion),e.body.securityanswer&&(n.securityanswer=e.body.securityanswer),e.body.usergroup&&(n.usergroup=e.body.usergroup),n.save((function(e){e&&r.status(500).send(e),r.status(200).json({serverMessage:"User updated!"})}))}))})),o.delete("/api/users/:User_Id",(function(e,r,t){return e.isAuthenticated()?t():r.status(401).send("User Unauthenticated")}),(function(e,r){e.params.User_Id.toLowerCase().trim()==e.user.username&&(u.SocketVariables.fusion_program_running&&u.SocketVariables.fusion_program_running.User==e.user.username&&c.KillProgram(),function(e){for(var r=0;r<u.connectedClients.length;r++)if(u.connectedClients[r].User.username==e){u.connectedClients[r].User=void 0;break}}(e.user.username),e.logout()),i.remove({username:e.params.User_Id.toLowerCase().trim()},(function(t,n){return t?r.send(t):(i.removeFileSystem(e.params.User_Id.toLowerCase().trim()),r.status(200).json({serverMessage:"Successfully deleted"}))}))})),o.post("/api/users/login",(async(e,r,o)=>{if(!u.MultiUserAccess&&m()>0)return r.status(500).send(e.__("LOGIN.MULTIUSER_DENIED"));if(n.connected){if(s.debug("Attempting classroom login"),"mriguest"==e.body.username&&"mriguest"==e.body.password)return r.status(500).send("Guest login unavailable in classroom mode");let n={method:"POST",uri:"https://172.16.0.1/backend/auth/ldap",body:{username:e.body.username,password:e.body.password},json:!0,rejectUnauthorized:!1,timeout:5e3};try{await t(n),await i.findOne({username:e.body.username}).exec()?await l(e,r,o):(e.body.securityquestion="Who is your favorite actor, musician, or artist?",e.body.securityanswer=e.body.username,e.body.usergroup="User",await d(e,r,o))}catch(t){return s.info("Error with request promise. "+t),"StatusCodeError"==t.name?r.status(401).send(e.__("LOGIN.INVALID")):"RequestError"==t.name?r.status(500).send("Error reaching classroom server"):r.status(500).send(t.message)}}else s.debug("Attempting standard login"),await l(e,r,o)})),o.post("/api/users/logout",(function(e,r,t){return e.isAuthenticated()?t():r.status(401).send("User Unauthenticated")}),(function(e,r){u.SocketVariables.fusion_program_running&&u.SocketVariables.fusion_program_running.User==e.user.username&&c.KillProgram(),function(e){for(var r=0;r<u.connectedClients.length;r++)if(u.connectedClients[r].id==e){u.connectedClients[r].User=void 0;break}}(e.body.socketId),e.logout(),r.status(200).json({serverMessage:"Logged out successfully"})})),o.get("/api/recovery/:User_Id",(function(e,r){i.findOne({username:e.params.User_Id.toLowerCase().trim()},(function(e,t){return e?r.status(500).send(e):t?r.status(200).json(t.securityquestion):r.status(500).send("User does not exist")}))})),o.post("/api/recovery",a.authenticate("local-recovery",{session:!0}),(async function(e,r){if(u.MultiUserAccess){if(n.connected)try{await y(user)}catch(e){s.error(e)}return f(e.body.socketId,e.user),r.status(200).json({serverMessage:"Login Successful",user:e.user})}if(0==m()){if(f(e.body.socketId,e.user),n.connected)try{await y(user)}catch(e){s.error(e)}return r.status(200).json({serverMessage:"Login Successful",user:e.user})}return e.logout(),r.status(500).send("Another user is already logged in.")})),o.get("/api/allowedUserGroups",(function(e,r){var t=["User"];i.findOne({usergroup:"Admin"},(function(e,n){return e||n||t.unshift("Admin"),r.status(200).send(t)}))})),o.get("/User/Login",(async(e,r,t)=>{t()}))}()}();