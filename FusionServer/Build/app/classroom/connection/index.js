!function(){const e=require("config"),t=require("../../utils/logger"),n=require("request-promise"),i=require("wireless-tools/wpa_cli"),a=require("getmac"),o=require("shelljs"),r=require("./../../utils/wireless");let s={wifiInterface:e.get("Wifi_NIC"),currentNetwork:0,networks:[{hiddenSSID:"MyBot_Gatekeeper_WiFi",hiddenPassword:"CMMthgilxoBsecure"}],serial:null,wifiStatus:null,fallbackNetwork:null};const c={connected:!1,connect:async function(){s.fallBackNetwork=await async function(){return new Promise(((e,n)=>(null?t.debug("Storing fallback network"):t.debug("No fallback network found"),e(null))))}(),s.serial=await new Promise(((e,n)=>{a.getMac({iface:"eth0"},(function(i,a){if(i)return n(i.message);{let n=a.split(":").join("").substr(-6);return t.debug("Fusion serial number: "+n),e(n)}}))})),s.wifiStatus=await new Promise(((e,n)=>{i.status(s.wifiInterface,(function(i,a){return i?n("Error accessing network interface: "+i):(t.debug("Wifi interface status: "+JSON.stringify(a)),e(a))}))})),await u()}};async function u(){const e="ip route show | grep -i '"+s.wifiInterface+"  metric' | awk '{print $3}'",i=await o.exec(e,{silent:!0}).stdout.trim();t.debug("Gateway found at: "+i);let a={uri:"https://"+i+":8443/api/v1/connect/"+s.serial,rejectUnauthorized:!1,json:!0,timeout:5e3};try{let e=await n(a);t.debug(JSON.stringify(e));let i=!1;if(e.data&&(i=e.data.community_access),i){let n={ssid:e.wifi.ssid,passphrase:e.wifi.passphrase};await async function(e){s.wifiStatus.ssid==e.ssid?(t.debug("Already connected to classroom network"),await l()):(t.debug("Not connected to classroom network"),await async function(e){try{t.debug("Connecting to classroom: "+e.ssid);let n={ssid:e.ssid,password:e.passphrase,hidden:!1};await r.connectToNetwork(n),await l()}catch(e){t.warn("Error connecting to classroom network: "+e)}}(e))}(n)}else t.debug("Not part of the classroom community"),await w()}catch(e){t.warn("Unable to reach classroom community: "+e),await w()}}async function l(){t.debug("Connecting classroom socket communication"),await require("../sockets"),c.connected=!0}async function w(){t.debug("Trying next hidden classroom network");let e=await async function(){let e=null;s.currentNetwork<s.networks.length&&(e=s.networks[s.currentNetwork++]);return e}();e?(t.debug("Next network is: "+e.hiddenSSID),await async function(e){try{t.debug("Connecting to hidden classroom: "+e.hiddenSSID);let n={ssid:e.hiddenSSID,password:e.hiddenPassword,hidden:!0};await r.connectToNetwork(n),t.debug("On hidden network, rechecking community access"),await u()}catch(e){t.warn(e),await w()}}(e)):(t.debug("No more networks to try. Restoring fallback network"),await async function(){t.debug("Checking for fallback network"),s.fallbackNetwork?t.debug("Fallback network found: "+s.fallbackNetwork):t.debug("No fallback network found")}())}module.exports=c}();