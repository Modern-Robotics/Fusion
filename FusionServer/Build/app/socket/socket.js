!function(){const e=require("../utils/logger"),n=require("."),i=require("../global/fusionSettings"),o=require("../fusionProgram"),t=require("request"),s=require("./../events");module.exports=async function(){e.verbose("Configuring socket communication"),i.connectedClients=[],n.on("connection",(function(r){i.connectedClients.push(r),e.debug(`Client connected: ${r.id}`),n.sockets.emit("version-number",i.SocketVariables.fusion_current_version),n.sockets.emit("update-available",i.SocketVariables.fusion_update_available),n.sockets.emit("gamepad-available",i.SocketVariables.fusion_gamepad_available),n.sockets.emit("diagnostics_running",i.SocketVariables.fusion_diagnostics_running),n.sockets.emit("program-running",i.SocketVariables.fusion_program_running),r.on("join",(function(e){r.emit("global-message",{message:"Connected to server",type:"success"}),s.emit("client-connected",i.connectedClients.length)})),r.on("disconnect",(function(c){e.debug(`Client disconnected: ${r.id} because "${c}"`),i.SocketVariables.fusion_program_running&&i.SocketVariables.fusion_program_running.SocketId==r.id&&o.KillProgram(),i.SocketVariables.fusion_diagnostics_running&&i.SocketVariables.fusion_diagnostics_running.socket==r.id&&(e.verbose("Terminating diagnostic tools due to absent client"),t({url:"http://localhost:8080/api/diagnostics/stop",method:"GET"},(function(o,t,s){o?e.error("Error terminating diagnostic tools : "+o):200==t.statusCode&&(i.SocketVariables.fusion_diagnostics_running=null),n.sockets.emit("diagnostics_running",i.SocketVariables.fusion_diagnostics_running)})));var a=i.connectedClients.indexOf(r);i.connectedClients.splice(a,1),s.emit("client-disconnected",i.connectedClients.length)})),r.on("error",(function(n){e.error("Socket error - "+n)}))}))}()}();