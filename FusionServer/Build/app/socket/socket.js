!function(){const e=require("../utils/logger"),n=require("."),i=require("../global/fusionSettings"),t=require("../fusionProgram"),o=require("request"),s=require("./../events"),r=require("./../utils/software");module.exports=async function(){e.verbose("Configuring socket communication"),i.connectedClients=[],n.on("connection",(function(c){i.connectedClients.push(c),e.debug(`Client connected: ${c.id}`),async function(){n.sockets.emit("version-number",await r.getCurrentVersion()),n.sockets.emit("update-available",await r.getUpdateAvailable()),n.sockets.emit("gamepad-available",i.SocketVariables.fusion_gamepad_available),n.sockets.emit("diagnostics_running",i.SocketVariables.fusion_diagnostics_running),n.sockets.emit("program-running",i.SocketVariables.fusion_program_running)}(),c.on("join",(function(e){c.emit("global-message",{message:"Connected to server",type:"success"}),s.emit("client-connected",i.connectedClients.length)})),c.on("disconnect",(function(r){e.debug(`Client disconnected: ${c.id} because "${r}"`),i.SocketVariables.fusion_program_running&&i.SocketVariables.fusion_program_running.SocketId==c.id&&t.KillProgram(),i.SocketVariables.fusion_diagnostics_running&&i.SocketVariables.fusion_diagnostics_running.socket==c.id&&(e.verbose("Terminating diagnostic tools due to absent client"),o({url:"http://localhost:8080/api/diagnostics/stop",method:"GET"},(function(t,o,s){t?e.error("Error terminating diagnostic tools : "+t):200==o.statusCode&&(i.SocketVariables.fusion_diagnostics_running=null),n.sockets.emit("diagnostics_running",i.SocketVariables.fusion_diagnostics_running)})));var a=i.connectedClients.indexOf(c);i.connectedClients.splice(a,1),s.emit("client-disconnected",i.connectedClients.length)})),c.on("error",(function(n){e.error("Socket error - "+n)}))}))}()}();