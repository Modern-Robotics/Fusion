!function(){const r=require("../utils/logger"),n=require("../socket"),o=require("../global/fusionSettings"),e=require("child_process").spawn,t=require("shelljs"),s=require("os"),i=require("path");let a=null;module.exports=function(){var u=function(){};function g(t,s){let u=`import os\nos.chdir('./app/filesystem/${s}/Editor')\nimport imp\nimp.load_source('util', r'${i.resolve(t)}')`;a=e("python",["-u","-B","-c",u],{stdio:"pipe"}),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),m(),a.stdout.on("data",(function(o){r.verbose(String(o).substring(0,o.lastIndexOf("\n"))),n.emit("console-output",{output:String(o)})})),a.stderr.on("data",(function(e){r.verbose(String(e).substring(0,e.lastIndexOf("\n"))),n.emit("console-output",{output:String(e)}),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),n.sockets.emit("gamepad-available",!1)})),a.stdout.on("close",(function(e){o.SocketVariables.fusion_program_running=null,r.verbose(String("> Program Finished!")),n.emit("console-output",{output:String("> Program Finished!\n")}),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),n.sockets.emit("gamepad-available",!1)}))}function l(t,i){let u=`import os\nos.chdir('./app/filesystem/${i}/Blockly')\nimport imp\n${t}`;a=(s.platform(),e("python",["-u","-B","-c",u],{stdio:"pipe"})),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),m(),a.stdout.on("data",(function(o){r.verbose(String(o).substring(0,o.lastIndexOf("\n"))),n.emit("blockly-console-output",{output:String(o)})})),a.stderr.on("data",(function(e){r.verbose(String(e).substring(0,e.lastIndexOf("\n"))),n.emit("blockly-console-output",{output:String(e)}),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),n.sockets.emit("gamepad-available",!1)})),a.stdout.on("close",(function(e){o.SocketVariables.fusion_program_running=null,r.verbose(String("> Program Finished!")),n.emit("blockly-console-output",{output:String("> Program Finished!\n")}),n.sockets.emit("program-running",o.SocketVariables.fusion_program_running),n.sockets.emit("gamepad-available",!1)}))}function m(){"win32"!=s.platform()&&setTimeout((function(){var r=t.exec("sudo netstat -panp | grep 5000 | grep LISTEN",{silent:!0}).stdout;o.SocketVariables.fusion_gamepad_available=!!r,n.sockets.emit("gamepad-available",o.SocketVariables.fusion_gamepad_available)}),1e3)}return u.StartProgram=function(n,e,t){if(o.SocketVariables.fusion_program_running){if(o.SocketVariables.fusion_program_running.User==n||"autonomous"==o.SocketVariables.fusion_program_running.SocketId){try{a.kill("SIGINT")}catch(r){}return o.SocketVariables.fusion_program_running={Code:null,Program:e,SocketId:t,User:n},g(e,n),r.verbose("Program is now running"),{status:200,message:"Program is now running"}}return r.verbose("Program already running"),{status:500,message:"Program already running"}}return o.SocketVariables.fusion_program_running={Code:null,Program:e,SocketId:t,User:n},g(e,n),r.verbose("Program is now running"),{status:200,message:"Program is now running"}},u.StopProgram=function(n){if(o.SocketVariables.fusion_program_running){if(o.SocketVariables.fusion_program_running.User==n||"autonomous"==o.SocketVariables.fusion_program_running.SocketId){o.SocketVariables.fusion_program_running=null;try{a.kill("SIGINT")}catch(r){}return r.verbose("Program is now stopped"),{status:200,message:"Program Successfully Stopped"}}return r.verbose("Cannot stop another user program"),{status:500,message:"Cannot stop another user's program."}}return r.verbose("No program running"),{status:500,message:"No Program Running"}},u.KillProgram=function(){o.SocketVariables.fusion_program_running=null;try{a.kill("SIGINT")}catch(r){}r.verbose("Program is now stopped")},u.StartBlocklyProgram=function(n,e,t){if(o.SocketVariables.fusion_program_running){if(o.SocketVariables.fusion_program_running.User==e||"autonomous"==o.SocketVariables.fusion_program_running.SocketId){try{a.kill("SIGINT")}catch(r){}return o.SocketVariables.fusion_program_running={Code:n,Program:null,SocketId:t,User:e},l(n,e),r.verbose("Blockly Program is now running"),{status:200,message:"Blockly Program is now running"}}return r.verbose("Program already running"),{status:500,message:"Program already running"}}return o.SocketVariables.fusion_program_running={Code:n,Program:null,SocketId:t,User:e},l(n,e),r.verbose("Blockly Program is now running"),{status:200,message:"Blockly Program is now running"}},u.sendInput=function(r){a.stdin.write(r+"\n")},u}()}();