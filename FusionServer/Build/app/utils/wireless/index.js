!function(){const t=require("config"),e=require("./../logger"),n=require("shelljs"),r=require("fs-extra"),o=require("os"),i=require("wireless-tools/wpa_cli"),s={networkInterface:t.get("Wifi_NIC"),connectToNetwork:async function(t){try{if("raspberrypi"!=o.hostname())throw"Windows wifi connecting not supported";const i=t.ssid,s=t.password;let a=0;t.hidden&&(a=1),e.verbose('Connecting to "'+i+'" using password: "'+s+'"');let c="";if(c+="ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev"+o.EOL,c+="update_config=1"+o.EOL,c+="country=US"+o.EOL,c+=""+o.EOL,c+="network={"+o.EOL,c+='\tssid="'+i+'"'+o.EOL,c+="\tscan_ssid="+a+o.EOL,c+='\tpsk="'+s+'"'+o.EOL,c+="\tkey_mgmt=WPA-PSK"+o.EOL,c+="}",e.debug("WPA supplicant data: \n"+c),await r.writeFile("/etc/wpa_supplicant/wpa_supplicant.conf",c),"FAIL"==n.exec("sudo wpa_cli -i "+this.networkInterface+" reconfigure",{silent:!0}).stdout.trim())throw"Invalid SSID or Password";const u=await this.monitorNetworkChange(i);e.info(u)}catch(t){throw t}},monitorNetworkChange:async function(n){return new Promise(((r,o)=>{e.debug("Monitoring network changes...");const i=this,s=t.get("Wireless.Connection.Timeout"),a=t.get("Wireless.Connection.Interval");let c=0,u=!1,w=setInterval((async function(){try{c+=a,e.debug(`Attempting network change for ${c} milliseconds`),c>=s&&(clearInterval(w),o(`${n} not found`));let t=await i.getNetworkStatus();const l=t.wpa_state,d=t.ip;"SCANNING"==l&&u&&(clearInterval(w),o(`Incorrect password for ${n}`)),"COMPLETED"==l&&(null!=d?(clearInterval(w),r(`Connected to ${n}`)):e.debug(`Connected to ${n} but waiting for IP assignment`)),["ASSOCIATING","ASSOCIATED","4WAY_HANDSHAKE"].includes(l)&&!u&&(u=!0,e.debug(`${n} found`))}catch(t){throw e.warn(t),t}}),a)}))},getNetworkStatus:async function(){return new Promise(((t,e)=>{i.status(this.networkInterface,(function(n,r){return n?e(n):t(r)}))}))}};module.exports=s}();