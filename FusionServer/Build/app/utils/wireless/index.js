!function(){const t=require("config"),e=require("./../logger"),n=require("shelljs"),o=require("fs-extra"),r=require("os"),i=require("wireless-tools/wpa_cli"),s={networkInterface:t.get("Wifi_NIC"),connectToNetwork:async function(t){try{if("raspberrypi"!=r.hostname())throw"Windows wifi connecting not supported";const i=t.ssid,s=t.password;let a=0;t.hidden&&(a=1),e.verbose('Connecting to "'+i+'" using password: "'+s+'"');let c="";if(c+="ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev"+r.EOL,c+="update_config=1"+r.EOL,c+="country=US"+r.EOL,c+=""+r.EOL,c+="network={"+r.EOL,c+='\tssid="'+i+'"'+r.EOL,c+="\tscan_ssid="+a+r.EOL,c+='\tpsk="'+s+'"'+r.EOL,c+="\tkey_mgmt=WPA-PSK"+r.EOL,c+="}",e.debug("WPA supplicant data: \n"+c),await o.writeFile("/etc/wpa_supplicant/wpa_supplicant.conf",c),"FAIL"==n.exec("sudo wpa_cli -i "+this.networkInterface+" reconfigure",{silent:!0}).stdout.trim())throw"Invalid SSID or Password";const u=await this.monitorNetworkChange(i);e.info(u)}catch(t){throw t}},monitorNetworkChange:async function(n){return new Promise(((o,r)=>{e.debug("Monitoring network changes...");const i=this,s=t.get("Wireless.Connection.Timeout"),a=t.get("Wireless.Connection.Scanning.IntervalCheck");let c=t.get("Wireless.Connection.Scanning.Timeout"),u=0,l=!1,w=setInterval((async function(){try{u+=a,e.debug(`Attempting network change for ${u} milliseconds`),u>=c&&(clearInterval(w),r(`${n} not found`));let t=await i.getNetworkStatus();const g=t.wpa_state,d=t.ip;"SCANNING"==g&&l&&(clearInterval(w),r(`Incorrect password for ${n}`)),"COMPLETED"==g&&(null!=d?(clearInterval(w),o(`Connected to ${n}`)):e.debug(`Connected to ${n} but waiting for IP assignment`)),["ASSOCIATING","ASSOCIATED","4WAY_HANDSHAKE"].includes(g)&&!l&&(l=!0,c=s,e.debug(`${n} found`))}catch(t){throw e.warn(t),t}}),a)}))},getNetworkStatus:async function(){return new Promise(((t,e)=>{i.status(this.networkInterface,(function(n,o){return n?e(n):t(o)}))}))}};module.exports=s}();