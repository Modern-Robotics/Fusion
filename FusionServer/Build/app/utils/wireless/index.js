!function(){const e=require("config"),t=require("./../logger"),n=require("shelljs"),o=require("fs-extra"),r=require("os"),i=require("wireless-tools/wpa_cli"),s={networkInterface:e.get("Wifi_NIC"),connectToNetwork:async function(e){try{if("5.15.0-50-generic"==r.release())throw"Windows wifi connecting not supported";const i=e.ssid,s=e.password;let c=0;e.hidden&&(c=1),t.verbose('Connecting to "'+i+'" using password: "'+s+'"');let a="";if(a+="ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev"+r.EOL,a+="update_config=1"+r.EOL,a+="country=US"+r.EOL,a+=""+r.EOL,a+="network={"+r.EOL,a+='\tssid="'+i+'"'+r.EOL,a+="\tscan_ssid="+c+r.EOL,a+='\tpsk="'+s+'"'+r.EOL,a+="\tkey_mgmt=WPA-PSK"+r.EOL,a+="}",t.debug("WPA supplicant data: \n"+a),await o.writeFile("/etc/wpa_supplicant/wpa_supplicant.conf",a),"FAIL"==n.exec("sudo wpa_cli -i "+this.networkInterface+" reconfigure",{silent:!0}).stdout.trim())throw"Invalid SSID or Password";const u=await this.monitorNetworkChange(i);t.info(u)}catch(e){throw e}},monitorNetworkChange:async function(n){return new Promise(((o,r)=>{t.debug("Monitoring network changes...");const i=this,s=e.get("Wireless.Connection.Timeout"),c=e.get("Wireless.Connection.Scanning.IntervalCheck");let a=e.get("Wireless.Connection.Scanning.Timeout"),u=0,l=!1,w=setInterval((async function(){try{u+=c,t.debug(`Attempting network change for ${u} milliseconds`),u>=a&&(clearInterval(w),r(`${n} not found`));let e=await i.getNetworkStatus();const g=e.wpa_state,d=e.ip;"SCANNING"==g&&l&&(clearInterval(w),r(`Incorrect password for ${n}`)),"COMPLETED"==g&&(null!=d?(clearInterval(w),o(`Connected to ${n}`)):t.debug(`Connected to ${n} but waiting for IP assignment`)),["ASSOCIATING","ASSOCIATED","4WAY_HANDSHAKE"].includes(g)&&!l&&(l=!0,a=s,t.debug(`${n} found`))}catch(e){throw t.warn(e),e}}),c)}))},getNetworkStatus:async function(){return new Promise(((e,t)=>{i.status(this.networkInterface,(function(n,o){return n?t(n):e(o)}))}))}};module.exports=s}();