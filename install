#!/bin/bash -x


# Base image:
# Raspberry Pi OS (Legacy)
# A port of Debian Buster with security updates and desktop environment
# Released: 2022-09-22


################################################################################
# Preconfiguration: Raspi-Config
################################################################################


########################################
# Interfaces
########################################

# Enable SSH
# Enable VNC
# Enable SPI
# Enable I2C
# Enable Serial Port
# Enable Serial Console


########################################
# Localization
########################################

# Set Locale
# Set Timezone
# Set WiFi Country


################################################################################
# Step 0: Parameters
################################################################################


########################################
# Define Variables Default Values
########################################

channel=$((1 + $RANDOM % 11))
ssid=RecruitAP_$(cat /sys/class/net/eth0/address | sed 's|:||g' | grep -o '.\{6\}$')
wpa_passphrase=mrirecruit
branch=Recruit
version=HEAD


########################################
# Overide Variables Values If Supplied
########################################

while getopts c:s:p:b:v: flag
do
    case "${flag}" in
        c) channel=${OPTARG};;
        s) ssid=${OPTARG};;
        p) wpa_passphrase=${OPTARG};;
        b) branch=${OPTARG};;
        v) version=${OPTARG};;
    esac
done


################################################################################
# Step 1: Install Required Libraries
################################################################################


########################################
# 1.A APT Packages
########################################

# Declare list of package names and versions
declare -A apt_packages
apt_packages["git"]=1:2.20.1-2+deb10u6 							# 1:2.20.1-2+deb10u3
apt_packages["python-smbus"]=4.1-1								# 4.1-1
apt_packages["python-pip"]=18.1-5+rpt1							# 18.1-5+rpt1
apt_packages["python-pil"]=5.4.1-2+deb10u3						# 5.4.1-2+deb10u3
apt_packages["python-numpy"]=1:1.16.2-1							# 1:1.16.2-1
apt_packages["python-dev"]=2.7.16-1								# 2.7.16-1
apt_packages["python3-pip"]=18.1-5+rpt1							# 18.1-5+rpt1
apt_packages["python3-pil"]=5.4.1-2+deb10u3						# 5.4.1-2+deb10u3
apt_packages["wiringpi"]=2.50									# 2.50
apt_packages["libjpeg8-dev"]=8d1-2								# Not Installed
apt_packages["imagemagick"]=8:6.9.10.23+dfsg-2.1+deb10u1		# Not Installed
apt_packages["libv4l-dev"]=1.16.3-3								# Not Installed
apt_packages["libusb-dev"]=2:0.1.12-32							# Not Installed
apt_packages["libftdi-dev"]=0.20-4								# Not Installed
apt_packages["libftdi1"]=0.20-4									# Not Installed
apt_packages["libftdi1-dev"]=1.4-1+b2							# Not Installed
apt_packages["hostapd"]=2:2.7+git20190128+0c1e29f-6+deb10u3		# Not Installed
apt_packages["dnsmasq"]=2.80-1+rpt1+deb10u1						# Not Installed
apt_packages["mongodb"]=1:2.4.14-4								# Not Installed
apt_packages["automake"]=1:1.16.1-4								# Not Installed

# Loop through package list, install specified version, and lock to prevent accidental upgrades
apt_update_needed=false
apt_update_performed=false
for key in ${!apt_packages[@]}; do    	
	if [[ $(apt-cache policy ${key} | awk '/Installed: /{ print $2 }') != ${apt_packages[${key}]} ]]; then
		apt_update_needed=true
		if [ $apt_update_needed == true ] && [ apt_update_performed == false ]; then
			sudo apt update
			apt_update_performed=true
		fi
		sudo apt-mark unhold ${key}
		sudo apt install ${key}=${apt_packages[${key}]} -y --allow-downgrades
		sudo apt-mark hold ${key}
	fi	
done

# Clean orphaned dependencies and cache
sudo apt autoremove -y
sudo apt autoclean -y


########################################
# 1.B Node.js
########################################

# Verify/Install NVM (Node Version Manager)
if [[ $(n -V) != "v9.0.1" ]]; then
	sudo curl -L https://raw.githubusercontent.com/tj/n/v9.0.1/bin/n -o /usr/local/bin/n
	sudo chmod 755 /usr/local/bin/n
fi

# Verify/Install Node.js
if [[ $(node -v) != "v9.10.1" ]]; then
	sudo n 9.10.1
fi


########################################
# 1.C: MyBot Software
########################################

if [ ! -d "/usr/Fusion" ]; then
	# Install software
	sudo git clone https://github.com/Modern-Robotics/Fusion.git /usr/Fusion --branch ${branch}
	sudo npm --prefix /usr/Fusion/FusionServer/Build install --production
else
	# Update software
	sudo git --git-dir /usr/Fusion/.git --work-tree=/usr/Fusion reset --hard HEAD
	sudo git --git-dir /usr/Fusion/.git --work-tree=/usr/Fusion pull
	sudo npm --prefix /usr/Fusion/FusionServer/Build install --production
fi


########################################
# 1.D: PIP Packages
########################################

# Dynamically retrieve fusion driver path and version
fusion_driver_path=$(find /usr/Fusion/lib/ -name Fusion-*.tar.gz)
fusion_driver_version=$(find /usr/Fusion/lib/ -name Fusion-*.tar.gz | grep -Eo '[0-9]+\.[0-9]+\.[0-9]')

# An embedded python script used to retrieve a pip package's version
# Currently used because the traditional 'pip show (package)' command is too slow
find_pip_package_version="
import sys
import pkg_resources
try:
	dist = pkg_resources.get_distribution(sys.argv[1])
	print('{}'.format(dist.version))
except pkg_resources.DistributionNotFound:
	print('')
"

# Declare list of pip package names and versions
declare -A pip_packages
pip_packages["Fusion"]=$fusion_driver_version
pip_packages["remi"]=1.1
pip_packages["pylibftdi"]=0.17.0
pip_packages["RPi.GPIO"]=0.7.0
pip_packages["spidev"]=3.5

# Loop through package list, install specified version
for key in ${!pip_packages[@]}; do
	installedVersion=$(python -c "$find_pip_package_version" ${key})
	if [[ $installedVersion != ${pip_packages[${key}]} ]]; then
		# Fusion package is installed from local directory
		if [[ ${key} == "Fusion" ]]; then
			sudo pip install $fusion_driver_path
		else
			sudo pip install ${key}==${pip_packages[${key}]}
		fi
	fi
done

########################################
# 1.D: LCD Libraries
########################################

# Move LCD library for easier python import usage
if [ ! -d "/usr/lib/python2.7/dist-packages/lcddisplay" ]; then
    sudo cp -R /usr/Fusion/lib/LCD_Module_RPI_code/RaspberryPi/python/lib /usr/lib/python2.7/dist-packages/lcddisplay
fi


################################################################################
# Step 2: Edit Configuration Files
################################################################################


########################################
# 2.A: DHCPCD
########################################

if [ ! -f "/etc/dhcpcd.conf.orig" ]; then
	sudo mv /etc/dhcpcd.conf /etc/dhcpcd.conf.orig
	sudo cp /usr/Fusion/config/dhcpcd/dhcpcd.conf /etc/dhcpcd.conf
fi


########################################
# 2.B: DNSMASQ
########################################

if [ ! -f "/etc/dnsmasq.conf.orig" ]; then
	sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
	sudo cp /usr/Fusion/config/dnsmasq/dnsmasq.conf /etc/dnsmasq.conf
fi


########################################
# 2.C: HOSTAPD
########################################

if [ ! -f "/etc/default/hostapd.orig" ]; then
	sudo mv /etc/default/hostapd /etc/default/hostapd.orig
	sudo cp /usr/Fusion/config/hostapd/hostapd /etc/default/hostapd
	sudo cp /usr/Fusion/config/hostapd/hostapd.conf /etc/hostapd/hostapd.conf
	sudo sed -i 's|^channel=.*$|channel='"${channel}"'|g' /etc/hostapd/hostapd.conf
	sudo sed -i 's|^ssid=.*$|ssid='"${ssid}"'|g' /etc/hostapd/hostapd.conf
	sudo sed -i 's|^wpa_passphrase=.*$|wpa_passphrase='"${wpa_passphrase}"'|g' /etc/hostapd/hostapd.conf
	sudo systemctl unmask hostapd.service
fi


########################################
# 2.C: HOSTS
########################################

if [ ! -f "/etc/hosts.orig" ]; then
	sudo mv /etc/hosts /etc/hosts.orig
	sudo cp /usr/Fusion/config/hosts /etc/hosts
fi


################################################################################
# Step 3: Configure Custom Services
################################################################################


########################################
# 3.A: APSTA
########################################

if [[ $(sudo systemctl is-active apsta.service) == "inactive" ]]; then
	sudo systemctl stop hostapd
	sudo systemctl stop dnsmasq
	sudo systemctl stop dhcpcd
	sudo systemctl disable hostapd
	sudo systemctl disable dnsmasq
	sudo systemctl disable dhcpcd
	sudo cp /usr/Fusion/bin/startDualNetworkMode /usr/local/bin/startDualNetworkMode
	sudo chmod 744 /usr/local/bin/startDualNetworkMode
	sudo cp /usr/Fusion/config/apsta.service /lib/systemd/system/apsta.service
	sudo chmod 644 /lib/systemd/system/apsta.service
	sudo systemctl daemon-reload
	sudo systemctl enable apsta.service
fi


########################################
# 3.B: Splashscreen
########################################

if [[ $(sudo systemctl is-active splashscreen.service) == "inactive" ]]; then
	sudo cp /usr/Fusion/config/splashscreen.service /lib/systemd/system/splashscreen.service
	sudo chmod 644 /lib/systemd/system/splashscreen.service
	sudo systemctl daemon-reload
	sudo systemctl enable splashscreen.service
fi


########################################
# 3.C: MyBot
########################################

if [[ $(sudo systemctl is-active mybot.service) == "inactive" ]]; then
	sudo cp /usr/Fusion/config/mybot.service /lib/systemd/system/mybot.service
	sudo chmod 644 /lib/systemd/system/mybot.service
	sudo systemctl daemon-reload
	sudo systemctl enable mybot.service
fi


################################################################################
# Step 4: Reboot
################################################################################

sudo reboot